---
layout: post
title: 函数与存储过程整理
date: 2020-12-06
author: 霁
header-img:
catalog: true
categories:
- 学习
- PLSQL
tags:
- PLSQL
- Oracle
---



1. 获取表以指定符号分隔的列字段

Oracle 存在 WM_CONCAT() 可将某些字段以行转列的形式以逗号拼接

```plsql
SELECT REPLACE(WM_CONCAT(A.COLUMN_NAME), ',', '||'',''||')
  FROM ALL_COL_COMMENTS A
```

```plsql
CREATE OR REPLACE FUNCTION GET_TABLE_COLUMS(IS_OWNER      IN VARCHAR2,
                                            IS_TABLE_NAME IN VARCHAR2,
                                            IS_STR        IN VARCHAR2 := ',')

 RETURN VARCHAR2 IS
  RESULT VARCHAR2(32767);
  CV     CLOB := '';
  TYPE REF_CURSOR_TYPE IS REF CURSOR;
  COLUMNS_CUR  REF_CURSOR_TYPE;
  VAL          VARCHAR2(100);
  V_OWNER      VARCHAR2(100);
  V_TABLE_NAME VARCHAR2(200);
  V_R          NUMBER := 0;
  V_STR        VARCHAR2(100);
BEGIN

  V_OWNER      := IS_OWNER;
  V_TABLE_NAME := IS_TABLE_NAME;
  V_STR        := IS_STR;

  OPEN COLUMNS_CUR FOR
    SELECT B.COLUMN_NAME AS COLUMN_NAME
      FROM ALL_TAB_COLUMNS B
     WHERE B.TABLE_NAME = V_TABLE_NAME
       AND B.OWNER = V_OWNER
     ORDER BY B.COLUMN_ID;
  LOOP
    FETCH COLUMNS_CUR
      INTO VAL;
    EXIT WHEN COLUMNS_CUR%NOTFOUND;
  
    IF MOD(V_R, 5) = 0
    THEN
      CV  := CV || V_STR || CHR(10) || VAL;
      V_R := 0;
    ELSE
      CV := CV || V_STR || VAL;
    END IF;
    V_R := V_R + 1;
  END LOOP;
  DBMS_OUTPUT.PUT_LINE(V_STR || ':' || LENGTH(V_STR));
  CV     := SUBSTR(CV, LENGTH(V_STR) + 2); -- 移除逗号和换行
  RESULT := TO_CHAR(CV);
  CLOSE COLUMNS_CUR;
  CV := '';
  RETURN(RESULT);
END GET_TABLE_COLUMS;
```

